<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ant Media - Collaborative Whiteboard</title>
    <link rel="stylesheet" href="../css/external/bootstrap4/bootstrap.min.css">
    <link rel="stylesheet" href="./custom-styles/play-demo.css">
    <style>
        .action-buttons-container { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }
        .action-button {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border: none; color: white; padding: 16px 40px; border-radius: 8px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 68, 68, 0.4); }
        .room-list { max-width: 600px; margin: 30px auto; }
        .room-item {
            background: white; border: 2px solid #e9ecef; border-radius: 8px;
            padding: 15px 20px; margin-bottom: 10px; cursor: pointer;
            transition: all 0.3s ease; display: flex;
            justify-content: space-between; align-items: center;
        }
        .room-item:hover { border-color: #ff4444; box-shadow: 0 4px 12px rgba(255, 68, 68, 0.2); transform: translateX(5px); }
        .room-name { font-weight: 600; color: #333; }
        .setup-view { max-width: 600px; margin: 0 auto; }
        .local-preview-container {
            background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px;
            position: relative; width: 100%; height: 400px;
        }
        .local-preview-container video-view { width: 100%; height: 100%; display: block; }
        .whiteboard-layout { display: flex; gap: 20px; height: calc(100vh - 200px); min-height: 600px; }
        .canvas-container {
            flex: 1; background: white; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); overflow: hidden;
            position: relative; display: flex;
        }
        .canvas-container collaborative-canvas { width: 100%; height: 100%; }
        .participants-sidebar { width: 280px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .participant-card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); overflow: hidden; flex-shrink: 0; }
        .participant-video { width: 100%; height: 180px; background: #000; position: relative; }
        .participant-video video-view { width: 100%; height: 100%; display: block; }
        .participant-label { padding: 8px 12px; font-size: 12px; color: #666; border-top: 1px solid #e9ecef; text-align: center; }
        .participant-controls { display: flex; justify-content: center; padding: 8px; border-top: 1px solid #e9ecef; }
        .participant-mute-btn {
            background: #f8f9fa; border: 1px solid #dee2e6; color: #495057;
            padding: 4px 12px; border-radius: 4px; cursor: pointer;
            font-size: 11px; transition: all 0.3s;
        }
        .participant-mute-btn:hover { background: #e9ecef; }
        .participant-mute-btn.muted { background: #dc3545; border-color: #dc3545; color: white; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        .loading-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); z-index: 9999;
            justify-content: center; align-items: center;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 60px; height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .room-info-banner {
            background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px;
            padding: 15px; margin-bottom: 20px; text-align: center;
        }
        .room-id-display { font-weight: 600; color: #155724; font-size: 1.1rem; }
        .controls-bar { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    </style>
</head>
<body>
<div class="container demo-container">
    
    <!-- Landing View -->
    <div id="landing-view" class="view-section active">
        <div class="demo-header">
            <h1 class="demo-title">Collaborative Whiteboard</h1>
            <p class="demo-subtitle">Draw together in real-time with video chat</p>
        </div>

        <div class="alert alert-primary" role="alert">
            <h5 class="alert-heading">üé® How It Works</h5>
            <p class="mb-2">Create or join a whiteboard room where you can <strong>draw collaboratively</strong> with others in real-time.</p>
            <ul class="mb-0" style="font-size: 14px;">
                <li><strong>New Room:</strong> Creates a whiteboard session with a unique room ID</li>
                <li><strong>Join Room:</strong> Browse and join existing active whiteboard sessions</li>
                <li><strong>Video Chat:</strong> See all participants while collaborating on the whiteboard</li>
                <li><strong>Real-Time Sync:</strong> All drawings are synchronized instantly across all participants</li>
            </ul>
        </div>

        <div class="action-buttons-container">
            <button id="create-room-button" class="action-button">Create New Room</button>
            <button id="join-room-button" class="action-button">Join Existing Room</button>
        </div>

        <div class="demo-footer mt-4">
            <a href="../index.html" class="back-link">‚Üê Back to Samples</a>
        </div>
    </div>

    <!-- Room Selection View -->
    <div id="room-selection-view" class="view-section">
        <div class="demo-header">
            <h2 class="demo-title">Select a Room</h2>
            <p class="demo-subtitle">Choose an active whiteboard room to join</p>
        </div>
        <div class="room-list" id="room-list"></div>
        <div class="text-center mt-3">
            <button id="back-to-landing-button" class="btn btn-secondary">‚Üê Back</button>
        </div>
    </div>

    <!-- Setup View -->
    <div id="setup-view" class="view-section">
        <div class="demo-header">
            <h2 class="demo-title">Setup Your Stream</h2>
            <p class="demo-subtitle">Configure your camera and microphone before joining</p>
        </div>
        <div class="setup-view">
            <div class="room-info-banner">
                <div>Room ID:</div>
                <div class="room-id-display" id="room-id-display"></div>
            </div>
            <div class="local-preview-container">
                <video-view id="local-preview" is-local show-controls="false"></video-view>
            </div>
            <div class="controls-bar">
                <toggle-camera id="toggle-camera"></toggle-camera>
                <toggle-microphone id="toggle-microphone"></toggle-microphone>
            </div>
            <div class="text-center mt-4">
                <button id="join-whiteboard-button" class="btn btn-success btn-lg">Join Whiteboard Room</button>
                <button id="cancel-setup-button" class="btn btn-secondary btn-lg ml-2">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Whiteboard Room View -->
    <div id="whiteboard-view" class="view-section">
        <div class="room-info-banner">
            <div>Room: <span class="room-id-display" id="active-room-id"></span></div>
            <button id="leave-room-button" class="btn btn-danger btn-sm ml-3">Leave Room</button>
        </div>
        <div class="whiteboard-layout">
            <div class="canvas-container">
                <collaborative-canvas id="whiteboard-canvas"></collaborative-canvas>
            </div>
            <div class="participants-sidebar" id="participants-sidebar"></div>
        </div>
    </div>
</div>

<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">Connecting to room...</div>
    </div>
</div>

<script src="../js/external/adapter-latest.js"></script>
<script type="module">
    import '../components/video-view.js';
    import '../components/toggle-camera.js';
    import '../components/toggle-microphone.js';
    import '../components/collaborative-canvas.js';
    import { SamplesConfig } from '../js/samples-config.js';
    import { WebRTCAdaptor } from '../js/ant-sdk/webrtc_adaptor.js';
    import { getWebSocketURL } from '../js/ant-sdk/utility.js';

    let serverUrl, roomId, myStreamId, adaptor;
    let participants = {};

    document.addEventListener('DOMContentLoaded', () => {
        serverUrl = SamplesConfig.getBackendUrl().origin + SamplesConfig.getBackendUrl().pathname;
        
        document.getElementById('create-room-button').onclick = () => {
            roomId = `wb_room_${Date.now()}`;
            showSetup();
        };
        document.getElementById('join-room-button').onclick = loadRooms;
        document.getElementById('back-to-landing-button').onclick = showLanding;
        document.getElementById('cancel-setup-button').onclick = showLanding;
        document.getElementById('join-whiteboard-button').onclick = joinRoom;
        document.getElementById('leave-room-button').onclick = leaveRoom;
    });

    function showView(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function showLanding() {
        showView('landing-view');
        if (adaptor) {
            adaptor.closeWebSocket();
            adaptor = null;
        }
        roomId = null;
    }

    async function loadRooms() {
        showView('room-selection-view');
        const list = document.getElementById('room-list');
        list.innerHTML = '<div class="text-center"><div class="spinner-border text-danger"></div><p class="mt-2">Loading...</p></div>';

        try {
            const res = await fetch(`${serverUrl}rest/v2/broadcasts/list/0/50?sort_by=date&order_by=desc`);
            const rooms = (await res.json()).filter(b => b.streamId.startsWith('wb_room_') && b.status === 'broadcasting');
            
            if (rooms.length === 0) {
                list.innerHTML = '<div class="text-center text-muted"><p>No active rooms. Create one!</p></div>';
                return;
            }

            list.innerHTML = '';
            rooms.forEach(room => {
                const item = document.createElement('div');
                item.className = 'room-item';
                item.innerHTML = `<div class="room-name">${room.streamId}</div><span class="badge badge-success">Active</span>`;
                item.onclick = () => { roomId = room.streamId; showSetup(); };
                list.appendChild(item);
            });
        } catch (e) {
            list.innerHTML = '<div class="alert alert-danger">Failed to load rooms</div>';
        }
    }

    function showSetup() {
        showView('setup-view');
        document.getElementById('room-id-display').textContent = roomId;

        adaptor = new WebRTCAdaptor({
            websocket_url: getWebSocketURL(SamplesConfig.getBackendUrl()),
            localVideoElement: document.createElement('video'),
            mediaConstraints: { video: { width: { min: 176, max: 640 } }, audio: true },
            dataChannelEnabled: true
        });

        document.getElementById('local-preview').setup(adaptor);
        document.getElementById('toggle-camera').setup(adaptor);
        document.getElementById('toggle-microphone').setup(adaptor);
    }

    function joinRoom() {
        console.log('[JOIN] Joining room:', roomId);
        document.getElementById('loading-overlay').classList.add('active');
        showView('whiteboard-view');
        document.getElementById('active-room-id').textContent = roomId;
        myStreamId = `participant_${Date.now()}`;
        console.log('[JOIN] My stream ID:', myStreamId);

        const canvas = document.getElementById('whiteboard-canvas');
        canvas.setup(adaptor);
        canvas.setStreamId(roomId);

        adaptor.addEventListener((info, obj) => {
            console.log(`[EVENT] ${info}`, obj?.streamId || '');
            
            if (info === 'publish_started') {
                console.log('[PUBLISH] Started, adding local video');
                addLocalVideo();
            }
            else if (info === 'play_started') {
                console.log('[PLAY] Started, fetching broadcast object');
                adaptor.getBroadcastObject(roomId);
                document.getElementById('loading-overlay').classList.remove('active');
            }
            else if (info === 'broadcastObject' && obj.broadcast) {
                const broadcast = JSON.parse(obj.broadcast);
                console.log('[BROADCAST] Object received:', obj.streamId, broadcast);
                
                if (obj.streamId === roomId) {
                    console.log('[ROOM] Main track, subTracks:', broadcast.subTrackStreamIds);
                    updateParticipants(broadcast.subTrackStreamIds || []);
                } else {
                    console.log('[PARTICIPANT] Subtrack registered:', obj.streamId);
                    participants[broadcast.streamId] = broadcast;
                }
            }
            else if (info === 'newTrackAvailable') {
                console.log('[TRACK] New track:', obj.trackId, 'kind:', obj.track.kind);
                addTrack(obj);
            }
        });

        console.log('[PUBLISH] Starting publish for:', myStreamId, 'to room:', roomId);
        adaptor.publish(myStreamId, null, null, null, null, roomId);
        
        console.log('[PLAY] Starting play for room:', roomId);
        adaptor.play(roomId, null, roomId, []);
    }

    function updateParticipants(activeIds) {
        console.log('[UPDATE] Active participants:', activeIds, 'Known:', Object.keys(participants));
        
        Object.keys(participants).forEach(id => {
            if (!activeIds.includes(id)) {
                console.log('[REMOVE] Participant left:', id);
                delete participants[id];
            }
        });
        
        activeIds.forEach(id => {
            if (id !== myStreamId && !participants[id]) {
                console.log('[NEW] Fetching participant info:', id);
                adaptor.getBroadcastObject(id);
            }
        });
    }

    async function addLocalVideo() {
        const existing = document.getElementById('local-video');
        if (existing) {
            console.warn('[LOCAL] Already exists, skipping duplicate');
            return;
        }
        
        console.log('[LOCAL] Creating local video element');
        const card = document.createElement('div');
        card.className = 'participant-card';
        card.innerHTML = `
            <div class="participant-video"><video-view id="local-video" is-local show-controls="false"></video-view></div>
            <div class="participant-label">You (Local)</div>
        `;
        document.getElementById('participants-sidebar').insertBefore(card, null);
        
        await customElements.whenDefined('video-view');
        setTimeout(() => {
            console.log('[LOCAL] Setting up video element');
            document.getElementById('local-video').setup(adaptor);
        }, 100);
    }

    async function addTrack(obj) {
        const trackLabel = obj.trackId.substring('ARDAMSx'.length);
        if (trackLabel === roomId || trackLabel === myStreamId) {
            console.log('[TRACK] Ignoring room/self track:', trackLabel);
            return;
        }

        const baseLabel = trackLabel.replace(/^(video|audio)Track/, 'track');
        console.log('[TRACK] Processing:', trackLabel, '‚Üí', baseLabel, 'kind:', obj.track.kind);
        
        let videoView = document.getElementById(`remote-video-${baseLabel}`);
        
        if (!videoView && obj.track.kind === 'video') {
            console.log('[CARD] Creating participant card:', baseLabel);
            const card = document.createElement('div');
            card.className = 'participant-card';
            card.id = `participant-${baseLabel}`;
            card.innerHTML = `
                <div class="participant-video"><video-view id="remote-video-${baseLabel}" show-controls="false"></video-view></div>
                <div class="participant-label">Participant</div>
                <div class="participant-controls">
                    <button class="participant-mute-btn" onclick="toggleMute('${baseLabel}')">üîä Unmuted</button>
                </div>
            `;
            document.getElementById('participants-sidebar').appendChild(card);
            await customElements.whenDefined('video-view');
            videoView = document.getElementById(`remote-video-${baseLabel}`);
            console.log('[CARD] Created:', baseLabel);
        }

        if (videoView) {
            setTimeout(() => {
                const video = videoView.video;
                if (video) {
                    if (!video.srcObject) video.srcObject = new MediaStream();
                    video.srcObject.addTrack(obj.track);
                    console.log('[TRACK] Added to video element:', baseLabel, obj.track.kind, 'Total tracks:', video.srcObject.getTracks().length);
                    
                    if (obj.track.kind === 'audio') {
                        video.muted = false;
                        video.volume = 1.0;
                    }
                    video.play();
                }
            }, 100);
        } else {
            console.warn('[TRACK] No video element found for:', baseLabel, obj.track.kind);
        }

        obj.track.onended = () => {
            console.log('[TRACK] Ended:', baseLabel, obj.track.kind);
            if (obj.track.kind === 'video') {
                removeParticipant(baseLabel);
            }
        };

        obj.stream.onremovetrack = (event) => {
            const remainingVideoTracks = Array.from(event.target.getTracks()).filter(t => t.kind === 'video' && t.readyState === 'live');
            console.log('[STREAM] Track removed from stream:', baseLabel, 'Remaining video tracks:', remainingVideoTracks.length);
            if (remainingVideoTracks.length === 0) {
                removeParticipant(baseLabel);
            }
        };
    }

    window.toggleMute = (id) => {
        const video = document.getElementById(`remote-video-${id}`)?.video;
        const btn = document.querySelector(`#participant-${id} .participant-mute-btn`);
        if (video && btn) {
            video.muted = !video.muted;
            btn.textContent = video.muted ? 'üîá Muted' : 'üîä Unmuted';
            btn.classList.toggle('muted', video.muted);
        }
    };

    function removeParticipant(id) {
        const card = document.getElementById(`participant-${id}`);
        if (card) {
            console.log('[REMOVE] Removing participant card:', id);
            card.remove();
        } else {
            console.warn('[REMOVE] Card not found:', id);
        }
    }

    function leaveRoom() {
        if (!confirm('Leave the room?')) return;
        if (adaptor) {
            adaptor.stop(myStreamId);
            adaptor.stop(roomId);
        }
        participants = {};
        document.getElementById('participants-sidebar').innerHTML = '';
        
        const oldCanvas = document.getElementById('whiteboard-canvas');
        const newCanvas = document.createElement('collaborative-canvas');
        newCanvas.id = 'whiteboard-canvas';
        oldCanvas.replaceWith(newCanvas);
        
        showLanding();
    }
</script>
</body>
</html> 